<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>composables/useJdModalPullDownClose.ts - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow-eighties.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles/style.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="JdModalRef.html">JdModalRef</a><ul class='methods'><li data-type='method'><a href="JdModalRef.html#close">close</a></li><li data-type='method'><a href="JdModalRef.html#close">close</a></li><li data-type='method'><a href="JdModalRef.html#closed">closed</a></li><li data-type='method'><a href="JdModalRef.html#closed">closed</a></li><li data-type='method'><a href="JdModalRef.html#component">component</a></li><li data-type='method'><a href="JdModalRef.html#data">data</a></li><li data-type='method'><a href="JdModalRef.html#destroy">destroy</a></li><li data-type='method'><a href="JdModalRef.html#destroy">destroy</a></li><li data-type='method'><a href="JdModalRef.html#disableShadow">disableShadow</a></li><li data-type='method'><a href="JdModalRef.html#duration">duration</a></li><li data-type='method'><a href="JdModalRef.html#entryComponent">entryComponent</a></li><li data-type='method'><a href="JdModalRef.html#floatingMode">floatingMode</a></li><li data-type='method'><a href="JdModalRef.html#fullHeight">fullHeight</a></li><li data-type='method'><a href="JdModalRef.html#id">id</a></li><li data-type='method'><a href="JdModalRef.html#observeClosed">observeClosed</a></li><li data-type='method'><a href="JdModalRef.html#observeClosed">observeClosed</a></li><li data-type='method'><a href="JdModalRef.html#observeOpener">observeOpener</a></li><li data-type='method'><a href="JdModalRef.html#observeOpener">observeOpener</a></li><li data-type='method'><a href="JdModalRef.html#opener">opener</a></li><li data-type='method'><a href="JdModalRef.html#openStrategy">openStrategy</a></li><li data-type='method'><a href="JdModalRef.html#overlayClose">overlayClose</a></li><li data-type='method'><a href="JdModalRef.html#panelElement">panelElement</a></li><li data-type='method'><a href="JdModalRef.html#panelStyle">panelStyle</a></li></ul></li><li><a href="JdModalService.html">JdModalService</a><ul class='methods'><li data-type='method'><a href="JdModalService.html#close">close</a></li><li data-type='method'><a href="JdModalService.html#close">close</a></li><li data-type='method'><a href="JdModalService.html#closeAll">closeAll</a></li><li data-type='method'><a href="JdModalService.html#closeAll">closeAll</a></li><li data-type='method'><a href="JdModalService.html#closeById">closeById</a></li><li data-type='method'><a href="JdModalService.html#closeById">closeById</a></li><li data-type='method'><a href="JdModalService.html#closeByRef">closeByRef</a></li><li data-type='method'><a href="JdModalService.html#closeByRef">closeByRef</a></li><li data-type='method'><a href="JdModalService.html#destroy">destroy</a></li><li data-type='method'><a href="JdModalService.html#destroy">destroy</a></li><li data-type='method'><a href="JdModalService.html#dispatchChangeState">dispatchChangeState</a></li><li data-type='method'><a href="JdModalService.html#dispatchChangeState">dispatchChangeState</a></li><li data-type='method'><a href="JdModalService.html#getModalRef">getModalRef</a></li><li data-type='method'><a href="JdModalService.html#getModalRef">getModalRef</a></li><li data-type='method'><a href="JdModalService.html#getState">getState</a></li><li data-type='method'><a href="JdModalService.html#getState">getState</a></li><li data-type='method'><a href="JdModalService.html#hasModal">hasModal</a></li><li data-type='method'><a href="JdModalService.html#hasModalRefNext">hasModalRefNext</a></li><li data-type='method'><a href="JdModalService.html#hasModalRefNext">hasModalRefNext</a></li><li data-type='method'><a href="JdModalService.html#init">init</a></li><li data-type='method'><a href="JdModalService.html#init">init</a></li><li data-type='method'><a href="JdModalService.html#isModalRefTop">isModalRefTop</a></li><li data-type='method'><a href="JdModalService.html#isModalRefTop">isModalRefTop</a></li><li data-type='method'><a href="JdModalService.html#modals">modals</a></li><li data-type='method'><a href="JdModalService.html#observeModalState">observeModalState</a></li><li data-type='method'><a href="JdModalService.html#observeModalState">observeModalState</a></li><li data-type='method'><a href="JdModalService.html#onChangeModalState">onChangeModalState</a></li><li data-type='method'><a href="JdModalService.html#onChangeModalState">onChangeModalState</a></li><li data-type='method'><a href="JdModalService.html#open">open</a></li><li data-type='method'><a href="JdModalService.html#open">open</a></li><li data-type='method'><a href="JdModalService.html#pushOrder">pushOrder</a></li><li data-type='method'><a href="JdModalService.html#pushOrder">pushOrder</a></li><li data-type='method'><a href="JdModalService.html#pushOrderById">pushOrderById</a></li><li data-type='method'><a href="JdModalService.html#pushOrderById">pushOrderById</a></li><li data-type='method'><a href="JdModalService.html#resetDefaultEntryComponent">resetDefaultEntryComponent</a></li><li data-type='method'><a href="JdModalService.html#resetDefaultEntryComponent">resetDefaultEntryComponent</a></li><li data-type='method'><a href="JdModalService.html#setDefaultEntryComponent">setDefaultEntryComponent</a></li><li data-type='method'><a href="JdModalService.html#setDefaultEntryComponent">setDefaultEntryComponent</a></li><li data-type='method'><a href="JdModalService.html#setUseBlockBodyScroll">setUseBlockBodyScroll</a></li><li data-type='method'><a href="JdModalService.html#setUseBlockBodyScroll">setUseBlockBodyScroll</a></li><li data-type='method'><a href="JdModalService.html#setUseHistoryState">setUseHistoryState</a></li><li data-type='method'><a href="JdModalService.html#setUseHistoryState">setUseHistoryState</a></li><li data-type='method'><a href="JdModalService.html#swapOrder">swapOrder</a></li><li data-type='method'><a href="JdModalService.html#swapOrder">swapOrder</a></li><li data-type='method'><a href="JdModalService.html#swapOrderTopById">swapOrderTopById</a></li><li data-type='method'><a href="JdModalService.html#swapOrderTopById">swapOrderTopById</a></li><li data-type='method'><a href="JdModalService.html#swapOrderTopByRef">swapOrderTopByRef</a></li><li data-type='method'><a href="JdModalService.html#swapOrderTopByRef">swapOrderTopByRef</a></li><li data-type='method'><a href="JdModalService.html#usedBlockBodyScroll">usedBlockBodyScroll</a></li><li data-type='method'><a href="JdModalService.html#usedHistoryState">usedHistoryState</a></li></ul></li></ul><h3>Interfaces</h3><ul><li><a href="JdModalBeforeLeaveHook.html">JdModalBeforeLeaveHook</a></li><li><a href="JdModalEntrySetupConfig.html">JdModalEntrySetupConfig</a></li><li><a href="JdModalEntrySetupHook.html">JdModalEntrySetupHook</a></li><li><a href="JdModalProviderSetupHook.html">JdModalProviderSetupHook</a></li><li><a href="JdModalScrollPreventHook.html">JdModalScrollPreventHook</a></li><li><a href="ModalConfig.html">ModalConfig</a></li><li><a href="ModalData.html">ModalData</a></li><li><a href="ModalEvent.html">ModalEvent</a></li><li><a href="ModalPopStateEvent.html">ModalPopStateEvent</a></li><li><a href="ModalState.html">ModalState</a></li></ul><h3>Global</h3><ul><li><a href="global.html#JD_MODAL_REF_TOKEN">JD_MODAL_REF_TOKEN</a></li><li><a href="global.html#JD_MODAL_SERVICE_TOKEN">JD_MODAL_SERVICE_TOKEN</a></li><li><a href="global.html#ModalEventType">ModalEventType</a></li><li><a href="global.html#ModalOpenStrategy">ModalOpenStrategy</a></li><li><a href="global.html#sleep">sleep</a></li><li><a href="global.html#useJdModalBeforeLeave">useJdModalBeforeLeave</a></li><li><a href="global.html#useJdModalEntrySetup">useJdModalEntrySetup</a></li><li><a href="global.html#useJdModalProviderSetup">useJdModalProviderSetup</a></li><li><a href="global.html#useJdModalPullDownClose">useJdModalPullDownClose</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">composables/useJdModalPullDownClose.ts</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { Subscription } from 'rxjs';
import { onMounted, onUnmounted, reactive, shallowRef, watch } from 'vue';
import { useJdModalRef, useJdModalService } from '../';

interface DragConfig {
  initialize?: boolean; // 자동 초기화
  dragResistance?: number; // 드래그 될 때 y 축 움직임 비율(높을수록 적게 움직임. 1 = 1:1, 2 = 1:1/2)
  triggerReleaseGap?: number; // 드래그 후 놨을때 움직인 거리 배수 시간(튕겨서 놓기 시간. 시간이 작을수록 빠르게 터치 start, end 하면 더 많은 거리로 계산 됨)
  triggerReleaseMinY?: number; // 드래그 후 놨을때 닫히는 최소 거리
}

/**
 * 모달 아래로 드래그 해서 닫기
 */
export const useJdModalPullDownClose = (config: DragConfig = {}) => {
  const {
    initialize = true,
    dragResistance = 1.2,
    triggerReleaseGap = 800,
    triggerReleaseMinY = 100
  } = config;
  const triggerReleaseMultiple = triggerReleaseGap / 2;
  const modalService = useJdModalService();
  const modalRef = useJdModalRef();
  const refScrollContainer = shallowRef&lt;HTMLElement>(null);
  let listener: Subscription;
  let panelElement: HTMLElement;
  let requestFrame: any = null;

  const state = reactive({
    startX: 0,
    startY: 0,
    startStamp: 0,
    checkMoveY: 0,
    moveIntercepCount: 0,
    moveY: 0,
    holding: false
  });

  // document touchstart
  const onTouchStart = (evt: TouchEvent) => {
    if (!panelElement) return;
    if (state.holding) return;
    const { clientX, clientY } = evt.touches[0];
    if (refScrollContainer.value) {
      const { scrollTop } = refScrollContainer.value;
      if (scrollTop === 0) {
        startFrame(clientX, clientY);
      }
    } else {
      startFrame(clientX, clientY);
    }
  };

  // document touchmove 전 방향 체크. x 축 이동으로 판단하면 onTouchMove 를 하지 않음
  const onTouchMoveIntercept = (evt: TouchEvent) => {
    const { startX, startY } = state;
    const { clientX, clientY } = evt.touches[0];
    const directionX = Math.abs(startX - clientX);
    const directionY = Math.abs(startY - clientY);
    const moveY = clientY - startY;
    state.moveIntercepCount++;
    state.checkMoveY = moveY;
    if (3 &lt; state.moveIntercepCount) {
      document.removeEventListener('touchmove', onTouchMoveIntercept);
      if (directionX &lt; directionY &amp;&amp; 0 &lt; moveY) {
        state.startY = clientY;
        document.addEventListener('touchmove', onTouchMove);
      }
    }
  };

  // document touchmove
  const onTouchMove = (evt: TouchEvent) => {
    const { startY } = state;
    const moveY = evt.touches[0].clientY;
    state.moveY = (moveY - startY) / dragResistance;
  };

  // document touchend
  const onTouchEnd = (evt: TouchEvent) => {
    document.removeEventListener('touchmove', onTouchMoveIntercept);
    document.removeEventListener('touchmove', onTouchMove);
    const { startStamp, moveY } = state;
    const triggerY = (triggerReleaseGap - (Date.now() - startStamp)) / triggerReleaseMultiple;
    const momentum = Math.max(1, triggerY) * moveY;
    if (triggerReleaseMinY &lt; momentum) {
      modalRef.close();
    } else {
      clearFrame();
      animateFrame();
    }
  };

  // 스크롤 컨테이너(DOM) 의 prevent 처리
  const onContainerTouchPrevent = (evt: TouchEvent) => {
    if (0 &lt; state.checkMoveY &amp;&amp; evt.cancelable) {
      evt.preventDefault();
    }
  };

  // 상태 업데이트
  const onUpdate = () => {
    const y = Math.max(0, state.moveY);
    panelElement.style.transform = `translate3d(0, ${y}px, 0)`;
  };

  // 드래깅 시작
  const startFrame = (startX: number, startY: number) => {
    clearFrame();
    state.startX = startX;
    state.startY = startY;
    state.startStamp = Date.now();
    state.moveIntercepCount = 0;
    document.removeEventListener('touchmove', onTouchMoveIntercept);
    document.addEventListener('touchmove', onTouchMoveIntercept);
  };

  // 드래깅 클리어
  const clearFrame = () => {
    cancelAnimationFrame(requestFrame);
    state.checkMoveY = 0;
  };

  // 드래깅 릴리즈
  const animateFrame = () => {
    const targetY = 0;
    const momentum = 0.33;
    const { moveY } = state;
    const y = moveY + (targetY - moveY) * momentum;
    state.moveY = y;
    if (1 &lt;= state.moveY) {
      requestFrame = requestAnimationFrame(animateFrame);
    } else {
      state.moveY = 0;
    }
  };

  // 초기화
  const init = () => {
    panelElement = modalRef.panelElement;
    panelElement.style.transition = 'transform 0ms';
    document.addEventListener('touchstart', onTouchStart);
    document.addEventListener('touchend', onTouchEnd);
    if (refScrollContainer.value) {
      refScrollContainer.value.addEventListener('touchmove', onContainerTouchPrevent);
      refScrollContainer.value.addEventListener('touchend', onContainerTouchPrevent);
    }
    const observe = modalService.observeModalState().subscribe(modalState => {
      const modals = modalState.modals;
      state.holding = modalRef.id !== modals[modals.length - 1]?.id;
    });
    listener = new Subscription();
    listener.add(observe);
  };

  // 파기
  const destroy = () => {
    document.removeEventListener('touchstart', onTouchStart);
    document.removeEventListener('touchmove', onTouchMoveIntercept);
    document.removeEventListener('touchmove', onTouchMove);
    document.removeEventListener('touchend', onTouchEnd);
    if (refScrollContainer.value) {
      refScrollContainer.value.removeEventListener('touchmove', onContainerTouchPrevent);
      refScrollContainer.value.removeEventListener('touchend', onContainerTouchPrevent);
    }
    listener.unsubscribe();
    listener = undefined;
  };

  // 강제로 스크롤 컨테이너를 바꿔야 하는 경우가 있을 때 사용.
  const setScrollContainer = (element: HTMLElement) => {
    refScrollContainer.value = element;
  };

  const changeScrollContainer = (element: HTMLElement) => {
    if (refScrollContainer.value) {
      destroy();
    }
    setScrollContainer(element);
    init();
  };

  watch(() => state.moveY, onUpdate);

  onMounted(() => {
    if (initialize) {
      setTimeout(init, 1);
    }
  });

  onUnmounted(() => {
    destroy();
  });

  return {
    refScrollContainer,
    init,
    destroy,
    changeScrollContainer
  };
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated at Thu Feb 24 2022 22:03:03 GMT+0000 (Coordinated Universal Time)
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
